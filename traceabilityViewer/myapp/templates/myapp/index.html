<!DOCTYPE html>
{% load static %}
<html>
    <head>
        <!-- Meta -->
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <!-- Favicon -->
        <link rel="icon" type="image/ico" href="{% static 'images/favicon.ico' %}"/>

        <!-- Scripts -->
        <script src="https://d3js.org/d3.v7.min.js"></script>
        <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
        <script src="https://unpkg.com/vue-async-computed"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.21.1/axios.min.js"></script>

        <!-- Stylesheet -->
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" crossorigin="anonymous">
        <link rel="stylesheet" href="{% static 'css/style.css' %}">
    </head>
    <body class="m-2">
        <div id="app">
        </div>
        <!-- Import App -->
        <script src="{% static 'main.js' %}"></script>
        <script src="{% static 'd3-force-sampled.js' %}"></script>
        <script src="{% static 'd3-force-reuse.js' %}"></script>
        <script id="worker" type="javascript/worker">
            importScripts("https://d3js.org/d3.v7.min.js")
            onmessage = function(event) {
                var nodes = event.data.nodes,
                    links = event.data.links;
                    yScale = event.data.yScale;
                    width = event.data.width;
                    height = event.data.heigth;

                var simulation = d3.forceSimulation(nodes)
                    .force("charge", d3.forceManyBody())
                    .force("link", d3.forceLink(links).id(function (d) {
                        return d.name; }))
                    .force("collide", d3.forceCollide().radius(11))
                    //.force("x", d3.forceX())
                    //.force("y", d3.forceY())
                    .force("forceY", d3.forceY(function (n){
                        for (group of Object.keys(yScale)){
                            if (n.layer_group == group){
                                return yScale[group]
                            }
                        }
                        return height.value / 2
                        return height / 2
                    }).strength(3))
                    .force('forceX', d3.forceX().strength(0.01).x(width / 2))
                    .stop();

                for (var i = 0, n = Math.ceil(Math.log(simulation.alphaMin()) / Math.log(1 - simulation.alphaDecay())); i < n; ++i) {
                  postMessage({type: "tick", progress: i / n});
                  simulation.tick();
                }

                postMessage({type: "end", nodes: nodes, links: links});
            };
        </script>
        <script src="{% static 'components/traceabilityViewer.js' %}"></script>
        <script src="{% static 'components/filter.js' %}"></script>
        <script src="{% static 'components/autocomplete.js' %}"></script>
        <script src="{% static 'components/graphviz.js' %}"></script>
        <script src="{% static 'components/legend.js' %}"></script>

        <!-- Mount App -->
        <script>
            app.mount('#app')
        </script>
    </body>
</html>
